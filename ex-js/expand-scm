#!/usr/local/bin/ypsilon

(import (pregexp))
(load "./scheme-to-js.scm")

(define (expand-scm scm-file-path)
  (let* ((file-name (car (pregexp-split "-sform\\.scm" scm-file-path)))
         (in (transcoded-port (open-file-input-port scm-file-path)
                              (make-transcoder (utf-8-codec))))
         (out (transcoded-port (open-file-output-port
                                (string-append file-name "-expanded.scm")
                                (file-options no-fail))
                               (make-transcoder (utf-8-codec))))
         (sform (read in))
         (expanded (macro-expand sform)))
    (pretty-print expanded out)
    (put-string out (format #f "~s" 'V-i\x60;22\x60;23*))
    (pretty-print sform)
    (newline)
    (newline)
    (pretty-print expanded)
    (newline)
    (newline)
    (display "JS\n")
    (display (scheme-to-javascript expanded))
    (newline)
    (close-input-port in)
    (close-output-port out)))

(define (main args)
  (expand-scm (cadr args)))

(main (command-line))


